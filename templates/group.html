{% extends "_base.html" %}

{% block title %}
{% endblock %}

{% block content %}

    <section id="p_timeline">
        <header>
            <div id="p_peopleCover">
                <div id="p_peopleName">
                    <div class="pui">
                        <div class="box">
                        <h1>{{ group.group_name }}</h1>
                            <div class="text">
                                {{ group.description }}
                            </div>
                        </div>
                    </div>
                    <p id="friendStatus">
                    </p>
                </div>
            </div>
        </header>
        <div id="p_profileContents" class="p_container">
            <div class="p_timelineContents">
                <section id="timeline_widget">
                    {% if permission != -1 %}
                    <div class="p_tItem p_container">
                    <a href="#" class="p_tAdd p_tIcon"></a>
                    <div class="p_tBox">
                        <ul class="writeSelect cboth">
                            <li class="wText"><a href="#">Text</a></li>
                            <li class="wArticle disabled"><a href="#">Article</a></li>
                            <li class="wPhoto"><a href="#">Photo</a></li>
                            <li class="wVideo disabled"><a href="#">Video</a></li>
                            <li class="wFile disabled"><a href="#">File</a></li>
                            <li class="wPoll disabled"><a href="#">Poll</a></li>
                            <li class="wCode disabled"><a href="#">Code</a></li>
                            <li class="wEvent disabled"><a href="#">Event</a></li>
                        </ul>
                        <section class="p_postForm">
                        <form id="form_post" method="post" action="">{% csrf_token %}
                            <textarea class="postFormText" id="post" name="post" placeholder="네 인생을 낭비해!!!"></textarea>
                            <div id="postAttach"></div>
                                <div class="postTools cboth">
                                    <p class="postOptions">
                                        <label class="text">{{ group.group_name }}</label>
                                        <select name="group">
                                            <option value="{{ group.id }}" selected></option>
                                        </select>
                                    </p>
                                    <input type="submit" class="postFormSubmit" value="작성">
                                </div>
                            </form>
                        </section>
                    </div>
                </div>
                {% endif %}
                </section>
                <section id="timeline_posts">
                </section>
            </div>
            <nav class="p_timelineNav">
            {% if permission == 1 or permission == 2 %}
                <div class="dropdown">
                    <a class="dropdown_display" id="toSetting" href="#">Settings</a>
                    <div class="dropdown_submenu" style="display: none; ">
                        <ul class="display_submenu_root">
                            <li><a href="#">멤버 추가</a></li>
                            <li><a href="members/">멤버 관리</a></li>
                            <li><a href="settings/">그룹 설정</a></li>
                        </ul>
                    </div>
                </div>
                <h3 class="weekly">그룹 가입 요청</h3>
                <ul id="member_request"></ul>
            {% endif %}
                <div id="siteInfo">
                    <p class="copy">&copy; Podium 2013</p>
                    <p><a href="#" class="about"><span>About</span></a> <sup>|</sup> <a href="#" class="developer"><span>Developer</span></a> <sup>|</sup> <a href="#" class="privacy"><span>개인정보보호</span></a> <sup>|</sup> <a href="#" class="eula"><span>이용약관</span></a></p>
                </div>
            </nav>
        </div>
    </section>

{% endblock %}

{% block add_scripts %}
    <script type="text/javascript">
        var delete_membership_noti = function(noti_id){
            var request_friend_url = "/api/v1/membershipnotis/"+noti_id+"/";
            $.ajax({
                type: "DELETE",
                url: request_friend_url,
                contentType: "application/json",
                dataType: "json",
                statusCode: {
                    204: function (data) {
                        console.log("member noti deleted = " + noti_id);
                    }
                }
            });
        }

        var accept_membership = function(){
            $("#member_request > li > a").click(function() {
                var noti_id = $(this).attr("name");
                var request_friend_url = "/api/v1/memberships/";
                var data = JSON.stringify({
                    "group_key": {{ group.id }},
                    "user_key": {{ user.id }}
                });
                $.ajax({
                    type: "POST",
                    url: request_friend_url,
                    contentType: "application/json",
                    data: data,
                    dataType: "json",
                    statusCode: {
                        201: function (data) {
                            console.log("member accept click");
                            delete_membership_noti(noti_id);
                            $("#friendStatus").html('<span class="friend">가입됨</span>');
                        }
                    }
                });
            });
        }

        var get_member_request= function(){
            var feedback_url = "/api/v1/membershipnotis/?noti_group_key={{ group.id }}&limit=8"; // TODO - 그룹 가입 요청 일정 갯수 이상시, 관리페이지로 안내
            $.ajax({
                type: "GET",
                url: feedback_url,
                contentType: "application/json",
                dataType: "json",
                statusCode: {
                    200: function(data) {
                        console.log("get member request");
                        console.log(data);
                        for(var index in data.objects) {
                            $("#member_request").append("<li><a href='#' name="+data.objects[index].id+"><span>"+data.objects[index].noti_user_key.username+"</span></a></li>");
                        }
                        accept_membership();
                        return false;
                    }
                }
            });
        };
        {% if permission == 1 or permission == 2 %}
        get_member_request();
        {% endif %}

        var request_membership = function(){
            $('#addFriend').click(function() {
                var request_friend_url = "/api/v1/membershipnotis/";
                var data = JSON.stringify({
                    "noti_group_key": {{ group.id }},
                    "noti_user_key": {{ user.id }}
                });
                $.ajax({
                    type: "POST",
                    url: request_friend_url,
                    contentType: "application/json",
                    data: data,
                    dataType: "json",
                    statusCode: {
                        201: function (data) {
                            console.log("request membership!");
                            $("#friendStatus").html('<span class="friend">요청 중</span>'); // TODO - 클릭시 요청 취소 Dropdown
                        }
                    }
                });
            });
        };

        var check_membership_noti = function(){
            var feedback_url = "/api/v1/membershipnotis/?noti_group_key={{ group.id }}&noti_user_key={{ user.id }}";
            $.ajax({
                type: "GET",
                url: feedback_url,
                contentType: "application/json",
                dataType: "json",
                statusCode: {
                    200: function (data) {
                        if(data.meta.total_count) {
                            console.log("already request member!");
                            $("#friendStatus").html('<span class="friend">요청 중</span>');
                        }
                        else {
                            console.log("not member!")
                            $("#friendStatus").html('<a href="#" id="addFriend">그룹 신청</span>');
                            request_membership();
                            return false;
                        }
                    }
                }
            });
        };

        $(function(){
            var feedback_url = "/api/v1/memberships/?group_key={{ group.id }}&user_key={{ user.id }}";
            $.ajax({
                type: "GET",
                url: feedback_url,
                contentType: "application/json",
                dataType: "json",
                statusCode: {
                    200: function (data) {
                        console.log("membership data");
                        console.log(data);
                        if(data.meta.total_count) {
                            console.log("already member!");
                            $("#friendStatus").html('<span class="friend">가입됨</span>');
                        }
                        else {
                            check_membership_noti();
                        }
                    }
                }
            });
        });
        $("select[name=group]").hide();

        // timeline.js의 arg : top polling url의 parameter
        var timeline_js_parameter_top_post_polling = "post__group__id={{ group.id }}";
        console.log("timeline_js_parameter_top_post_polling = " + timeline_js_parameter_top_post_polling);
    </script>
    {% include 'post_public.html' %}
    <script type="text/javascript" src="{{ STATIC_URL }}js/timeline.js"></script>
{% endblock %}