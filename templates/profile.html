{% extends "_base.html" %}

{% block title %}
{% endblock %}

{% block content %}

    <section id="p_timeline">
        <header>
            <div id="p_peopleCover">
                <div id="p_peopleName">
                    <span id="p_peoplePicture">
                        {% with user_pageowner.userpictures_set.all|first as userpicture %}
                            {% if userpicture %}
                                <img src="{{ userpicture.picture }}" alt="{{ userpicture.name }}" class="peoplePicture" />
                            {% else %}
                                <img src="{{ STATIC_URL }}images/user_defaultProfile.jpg" alt="기본 프로필 사진" class="peoplePicture" />
                            {% endif %}
                        {% endwith %}
                    </span>
                    <h1>{{ user_pageowner.username }}</h1>
                    <p id="friendStatus">
                    </p>
                </div>
            </div>
        </header>
        <div id="p_profileContents" class="p_container">
            <div class="p_timelineContents">
                <section id="timeline_widget">
                    <div class="p_tItem p_container">
                        <a href="#" class="p_tAdd p_tIcon"></a>
                        <div class="p_tBox">
                            <ul class="writeSelect cboth">
                                <li class="wText"><a href="#">Text</a></li>
                                <li class="wArticle disabled"><a href="#">Article</a></li>
                                <li class="wPhoto"><a href="#">Photo</a></li>
                                <li class="wVideo disabled"><a href="#">Video</a></li>
                                <li class="wFile disabled"><a href="#">File</a></li>
                                <li class="wPoll disabled"><a href="#">Poll</a></li>
                                <li class="wCode disabled"><a href="#">Code</a></li>
                                <li class="wEvent disabled"><a href="#">Event</a></li>
                            </ul>
                            <section class="p_postForm">
                                <form id="form_post" method="post" action="">{% csrf_token %}
                                    <textarea class="postFormText" id="post" name="post" placeholder="네 인생을 낭비해!!!"></textarea>
                                    <div id="postAttach"></div>
                                    <div class="postTools cboth">
                                        <p class="postOptions">
                                            {% if user_pageowner != user %}
                                                <input type="hidden" name="target_user" value="{{ user_pageowner.id }}">
                                            {% endif %}
                                            <label class="text">공개범위</label>
                                            <select name="open_scope" value="공개범위">
                                                <option value="public">공개</option>
                                                <option value="private">비공개</option>
                                            </select>
                                        </p>
                                        <input type="submit" class="postFormSubmit" value="작성">
                                    </div>
                                </form>
                            </section>
                        </div>
                    </div>
                </section>
                <section id="timeline_posts">
                </section>
            </div>
        </div>
    </section>

    <input name="friend_id" id="friend_id" type="hidden" value="{{ user_pageowner.id }}">

{% endblock %}

{% block add_scripts %}
    <script type="text/javascript">
        $(function(){
            if ({{ user_pageowner.id }} == {{ user.id }}){
                return false;
            }
            var request_friend_url = "/api/v1/friend_noti/";
            var data = JSON.stringify({
                "friend_id": {{ user_pageowner.id }}
            });
            $.ajax({
                type: "GET",
                url: request_friend_url,
                contentType: "application/json",
                data: data,
                dataType: "json",
                statusCode: {
                    200: function (data) {
                        /*post로 Noti 생성한 후 json response*/
                        if(data.meta.total_count) {
                            $("#friendStatus").html('<span class="friend">친구</span>');
                        }
                        else {
                            $("#friendStatus").html('<a href="#" id="addFriend">친구 추가</span>');

                            $('#addFriend').click(function (event) {
                                var request_friend_url = "/api/v1/friend_noti/";
                                var data = JSON.stringify({
                                    "friend_id": {{ user_pageowner.id }}
                                });
                                console.log("friend id = " + data.friend_id);
                                $.ajax({
                                    type: "POST",
                                    url: request_friend_url,
                                    contentType: "application/json",
                                    data: data,
                                    dataType: "json",
                                    statusCode: {
                                        201: function (data) {
                                            /*post로 Noti 생성한 후 json response*/
                                            console.log("request friend to django server, [response] = [" + data + "]");
                                            $("#friendStatus").html('<span class="friend">친구</span>');
                                        }
                                    }
                                });
                            });
                        }
                    }
                }
            });
        });

        var noti_check_friend = setInterval(function () {
            $('#form_noti_check_friend').submit(function (event) {
                var noti_check_friend_url = "/api/v1/friend_noti/?noti_to_user=" + user_id; //자기 자신의 유저 아이디
                $.ajax({
                    type: "GET",
                    url: noti_check_friend_url,
                    contentType: "application/json",
                    dataType: "json",
                    statusCode: {
                        200: function (data) {
                            console.log("request friend to django server, [response] = [" + data + "]");
                            accept_friend_request(data.friend_id); //accept or reject but, now always accept
                        }
                    }
                });
                return false;
            });
        }, 5000);

        var accept_friend_request = (function(friend_id) {
            console.log('friend_id = ' + friend_id);
            var accept_friendship_url = "/api/v1/friendship/";
            accept_friend_data = JSON.stringify({
               friend_id : friend_id
            });
            $.ajax({
                type: 'POST',
                url: accept_friend_request_url,
                contentType: "application/json",
                data: accept_friend_data,
                dataType: "json",
                statusCode: {
                    201: function (data) {
                        console.log("accept_friendship, [response] = [" + data + "]");
                    }
                }
            });
            return false;
        });

        // timeline.js의 arg : top polling url의 parameter
        var timeline_js_parameter_top_post_polling = "user__id={{ user_pageowner.id }}&!post__open_scope=1"; // TODO(ym) - not equal parameter filtering
        console.log("timeline_js_parameter_top_post_polling = " + timeline_js_parameter_top_post_polling);
    </script>
    {% include 'post_public.html' %}
    <script type="text/javascript" src="{{ STATIC_URL }}js/timeline.js"></script>
{% endblock %}