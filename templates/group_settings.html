{% extends "_base.html" %}

{% block title %}
    {{ page_title  }}
{% endblock %}

{% block content %}
    <section id="p_timeline">
        <div class="p_container pui">
            <div class="box">
                <div class="text">
                    <p>그룹 설정</p>
                    <form id="group_update_form" method="post" action="">{% csrf_token %}
                        <pre>
                        <label class="text">그룹이름</label><input type="text" name="group_name" value="{{ group.group_name }}">
                        <label class="text">설명</label><textarea class="postFormText" name="description" placeholder="멤버들에게 소식을 전하세요.">{{ group.description }}</textarea>
                        <label class="text">프로젝트?</label><input type="checkbox" name="is_project" {% if group.isProject %}checked{% endif %}>
                        <label class="text">공개범위</label>
                        <select name="open_scope">
                            <option value="open" {% if group.open_scope == 0 %}selected{% endif %}>모두에게 공개</option>
                            <option value="semi-open" {% if group.open_scope == 1 %}selected{% endif %}>멤버들에게만 공개</option>
                            <option value="close" {% if group.open_scope == 2 %}selected{% endif %}>비공개</option>
                        </select>
                        </pre>
                        <div class="text-center">
                            <div id="group_response" class="tooltip-parent tooltip-hover">
                                <input class="btn tooltip-parent tooltip-hover" type="submit" name="group_submit" value="수정">
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="box">
                <div class="text member_list">
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block add_scripts %}
    <script type="text/javascript">
        var group_id = {{ group.id }};

        var get_member_list = function() {
            var feedback_url = "/api/v1/memberships/?group_key="+group_id;
            $.ajax({
                type: "GET",
                url: feedback_url,
                contentType: "application/json",
                dataType: "json",
                statusCode: {
                    200: function (data) {
                        console.log("group user list get!");
                        console.log(data);
                        for(var index in data.objects){
                            $(".member_list").append("<li><a href='#' name='"+data.objects[index].id+"' tag='"+data.objects[index].permission+"'>"+data.objects[index].user_key.username+"</a></li>");
                        }
                    }
                }
            });
        }
        get_member_list();

        var click_dropdown_make_for_permission = function(eventdom){
            var member_id = $(eventdom).attr("name");
            var member_permission = $(eventdom).attr("tag");
            var data = {
                "id": member_id,
                "permission": member_permission
            };
            $("#select_member").tmpl(data).appendTo(eventdom);
        };

        $(document).on("mouseover", ".member_list > li > a", function(){
            if($(this).find(".permission_click").size() == 0) {
                click_dropdown_make_for_permission($(this));
            }
        });

        var click_member_for_permission = function(eventdom){
            var membership_id = eventdom.attr("name");
            var set_permission = eventdom.attr("tag");
            var method;
            switch (set_permission) {
                case "0":
                    method = "PATCH";
                    break;
                case "1":
                    method = "PATCH";
                    break;
                case "-1":
                    method = "DELETE";
                    break;
                default:
                    break;
            };
            var feedback_url = "/api/v1/memberships/"+membership_id+"/"
            var data = JSON.stringify({
                "permission": set_permission
            });
            console.log(data);
            console.log(method);
            $.ajax({
                type: method,
                url: feedback_url,
                contentType: "application/json",
                data: data,
                dataType: "json",
                satusCode: {
                    200: function(data) {
                        console.log("permission update done!");
                    }
                }
            });
        };

        $(document).on("click", ".permission_click", function(){
            click_member_for_permission($(this));
        });
    </script>
    <script id="select_member" type="text/x-jquery-tmpl">
        <div class="dropbottom">
            <div class="dropmid">
                <ul>
                {% templatetag openblock %}if permission == 1{% templatetag closeblock %}
                    <li><a class="permission_click" href="#" name="${id}" tag="0">관리자에서 제외</a></li>
                {% templatetag openblock %}else{% templatetag closeblock %}
                    <li><a class="permission_click" href="#" name="${id}" tag="1">관리자로 설정</a></li>
                {% templatetag openblock %}/if{% templatetag closeblock %}
                    <li><a class="permission_click" href="#" name="${id}" tag="-1">그룹에서 제외</a></li>
                </ul>
            </div>
        </div>
    </script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/group.js"></script>
{% endblock %}